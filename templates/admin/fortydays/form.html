{% extends 'admin/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .flatpickr-calendar {
        font-family: inherit;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .flatpickr-day.selected {
        background: var(--primary) !important;
        border-color: var(--primary) !important;
    }
    .flatpickr-day.selected:hover {
        background: var(--primary_hover) !important;
    }
    .flatpickr-day.today {
        border-color: var(--primary) !important;
    }
    .flatpickr-day.today:hover {
        background: rgba(7, 89, 68, 0.1) !important;
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold" style="color: var(--text);">{% if object %}Edit 40 Days Configuration{% else %}Create New 40 Days Configuration{% endif %}</h1>
    <p class="text-sm mt-1" style="color: var(--text_secondary);">Configure the annual 40 Days of Prayer, Planning & Planting event</p>
</div>

<form method="post" enctype="multipart/form-data" class="bg-white rounded-lg shadow-sm p-6 border" style="border-color: var(--border);">
    {% csrf_token %}
    <div class="space-y-6">
        <div class="border-b pb-4" style="border-color: var(--border);">
            <h2 class="text-lg font-semibold mb-4" style="color: var(--text);">Banner Image</h2>
            <div class="mb-6">
                <label for="{{ form.banner_image.id_for_label }}" class="block text-sm font-medium mb-2" style="color: var(--text);">Banner/Flyer Image</label>
                {{ form.banner_image }}
                {% if form.banner_image.errors %}<p class="text-sm text-red-600 mt-1">{{ form.banner_image.errors.0 }}</p>{% endif %}
                {% if object and object.banner_image %}
                <div class="mt-3">
                    <p class="text-xs mb-2" style="color: var(--text_light);">Current banner:</p>
                    <img src="{{ object.banner_image.url }}" alt="Current banner" class="max-w-md h-32 object-cover rounded-lg border" style="border-color: var(--border);">
                </div>
                {% endif %}
                <p class="text-xs mt-1" style="color: var(--text_light);">Optional: Upload a banner/flyer image for the 40 Days section on the homepage</p>
                <p class="text-xs mt-1" style="color: #f59e0b;">ðŸ’¡ Tip: For faster uploads, compress images to under 2MB before uploading</p>
            </div>
        </div>

        <div class="border-b pb-4" style="border-color: var(--border);">
            <h2 class="text-lg font-semibold mb-4" style="color: var(--text);">Date Range</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="{{ form.start_date.id_for_label }}" class="block text-sm font-medium mb-2" style="color: var(--text);">Start Date *</label>
                    <input type="text" 
                           id="{{ form.start_date.id_for_label }}" 
                           name="{{ form.start_date.name }}" 
                           value="{% if form.start_date.value %}{{ form.start_date.value }}{% endif %}"
                           class="date-picker w-full px-3 py-2 border rounded-lg" 
                           style="border-color: var(--border); color: var(--text); cursor: pointer;"
                           placeholder="Select start date"
                           data-date-picker="start"
                           autocomplete="off"
                           readonly
                           data-lpignore="true"
                           data-form-type="other">
                    {% if form.start_date.errors %}<p class="text-sm text-red-600 mt-1">{{ form.start_date.errors.0 }}</p>{% endif %}
                </div>
                <div>
                    <label for="{{ form.end_date.id_for_label }}" class="block text-sm font-medium mb-2" style="color: var(--text);">End Date *</label>
                    <input type="text" 
                           id="{{ form.end_date.id_for_label }}" 
                           name="{{ form.end_date.name }}" 
                           value="{% if form.end_date.value %}{{ form.end_date.value }}{% endif %}"
                           class="date-picker w-full px-3 py-2 border rounded-lg" 
                           style="border-color: var(--border); color: var(--text); cursor: pointer;"
                           placeholder="Select end date"
                           data-date-picker="end"
                           autocomplete="off"
                           readonly
                           data-lpignore="true"
                           data-form-type="other">
                    {% if form.end_date.errors %}<p class="text-sm text-red-600 mt-1">{{ form.end_date.errors.0 }}</p>{% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text);">Status</label>
                    <div class="flex items-center mt-2">
                        {{ form.is_active }}
                        <span class="ml-2 text-sm" style="color: var(--text);">Active</span>
                    </div>
                    <p class="text-xs mt-1" style="color: var(--text_light);">Only active configurations will show live buttons on the homepage</p>
                </div>
            </div>
        </div>

        <div class="border-b pb-4" style="border-color: var(--border);">
            <h2 class="text-lg font-semibold mb-4" style="color: var(--text);">Morning Session (5:00-5:30am Ghana time)</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text);">YouTube Live URL</label>
                    {{ form.morning_youtube_url }}
                    {% if form.morning_youtube_url.errors %}<p class="text-sm text-red-600 mt-1">{{ form.morning_youtube_url.errors.0 }}</p>{% endif %}
                    <p class="text-xs mt-1" style="color: var(--text_light);">Optional: YouTube live stream URL for morning sessions</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text);">Facebook Live URL</label>
                    {{ form.morning_facebook_url }}
                    {% if form.morning_facebook_url.errors %}<p class="text-sm text-red-600 mt-1">{{ form.morning_facebook_url.errors.0 }}</p>{% endif %}
                    <p class="text-xs mt-1" style="color: var(--text_light);">Optional: Facebook live stream URL for morning sessions</p>
                </div>
            </div>
        </div>

        <div>
            <h2 class="text-lg font-semibold mb-4" style="color: var(--text);">Evening Session (6:00-7:00pm Ghana time)</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text);">YouTube Live URL</label>
                    {{ form.evening_youtube_url }}
                    {% if form.evening_youtube_url.errors %}<p class="text-sm text-red-600 mt-1">{{ form.evening_youtube_url.errors.0 }}</p>{% endif %}
                    <p class="text-xs mt-1" style="color: var(--text_light);">Optional: YouTube live stream URL for evening sessions</p>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text);">Facebook Live URL</label>
                    {{ form.evening_facebook_url }}
                    {% if form.evening_facebook_url.errors %}<p class="text-sm text-red-600 mt-1">{{ form.evening_facebook_url.errors.0 }}</p>{% endif %}
                    <p class="text-xs mt-1" style="color: var(--text_light);">Optional: Facebook live stream URL for evening sessions</p>
                </div>
            </div>
        </div>
    </div>
    <div class="mt-6 flex items-center space-x-4">
        <button type="submit" id="submit-btn" class="px-6 py-2 rounded-lg text-white font-semibold transition-all" style="background: var(--primary);">
            <span id="submit-text">{% if object %}Update{% else %}Create{% endif %} Configuration</span>
            <span id="submit-spinner" class="hidden inline-flex items-center">
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Saving...
            </span>
        </button>
        <a href="{% url 'manage:fortydays_list' %}" class="px-6 py-2 rounded-lg border" style="border-color: var(--border); color: var(--text_secondary);">Cancel</a>
    </div>
</form>

<script>
    // Show loading state when form is submitted
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form[method="post"]');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');
        
        if (form && submitBtn) {
            form.addEventListener('submit', function(e) {
                // Show spinner and disable button
                submitText.classList.add('hidden');
                submitSpinner.classList.remove('hidden');
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.7';
                submitBtn.style.cursor = 'not-allowed';
            });
        }
        
        // Check if banner image is being uploaded and warn about large files
        const bannerInput = document.querySelector('input[type="file"][name="banner_image"]');
        if (bannerInput) {
            bannerInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const fileSizeMB = file.size / (1024 * 1024);
                    if (fileSizeMB > 5) {
                        alert('Warning: The image file is large (' + fileSizeMB.toFixed(2) + ' MB). This may take longer to upload. Consider compressing the image first.');
                    }
                }
            });
        }
    });
</script>

<style>
    input[type="text"], input[type="url"] { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; font-size: 0.875rem; color: var(--text); }
    input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(7, 89, 68, 0.1); }
    input[type="checkbox"] { width: 1.25rem; height: 1.25rem; cursor: pointer; }
    .date-picker { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; padding-right: 2.5rem; }
</style>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize date picker for start date
        const startDateInput = document.getElementById('{{ form.start_date.id_for_label }}');
        const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
        
        if (startDateInput && endDateInput) {
            // Remove readonly to allow Flatpickr to work (but prevent Chrome autocomplete)
            startDateInput.removeAttribute('readonly');
            endDateInput.removeAttribute('readonly');
            
            // Add event listeners to prevent Chrome autocomplete dropdown
            [startDateInput, endDateInput].forEach(function(input) {
                // Prevent autocomplete on focus
                input.addEventListener('focus', function(e) {
                    e.target.setAttribute('autocomplete', 'off');
                    e.target.setAttribute('readonly', 'readonly');
                    // Remove readonly after a tiny delay so Flatpickr can handle it
                    setTimeout(function() {
                        e.target.removeAttribute('readonly');
                    }, 10);
                });
                
                // Prevent autocomplete on click
                input.addEventListener('click', function(e) {
                    e.target.setAttribute('autocomplete', 'off');
                });
                
                // Prevent autocomplete on input
                input.addEventListener('input', function(e) {
                    e.target.setAttribute('autocomplete', 'off');
                });
            });
            
            const startPicker = flatpickr(startDateInput, {
                dateFormat: "Y-m-d",
                allowInput: false, // Disable manual input to prevent Chrome autocomplete
                clickOpens: true,
                disableMobile: false,
                onChange: function(selectedDates, dateStr, instance) {
                    // Update end date min date to be start date or later
                    if (endPicker && selectedDates[0]) {
                        endPicker.set('minDate', selectedDates[0]);
                    }
                    // Ensure autocomplete is off after selection
                    startDateInput.setAttribute('autocomplete', 'off');
                }
            });
            
            const endPicker = flatpickr(endDateInput, {
                dateFormat: "Y-m-d",
                allowInput: false, // Disable manual input to prevent Chrome autocomplete
                clickOpens: true,
                disableMobile: false,
                minDate: startDateInput.value || "today",
                onChange: function(selectedDates, dateStr, instance) {
                    // Ensure autocomplete is off after selection
                    endDateInput.setAttribute('autocomplete', 'off');
                }
            });
            
            // If start date already has a value, set it as min for end date
            if (startDateInput.value) {
                endPicker.set('minDate', startDateInput.value);
            }
        }
    });
</script>
{% endblock %}

