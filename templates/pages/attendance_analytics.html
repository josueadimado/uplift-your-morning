{% extends 'base.html' %}

{% block title %}Attendance Analytics{% endblock %}

{% block extra_css %}
<style>
    /* Mobile-first responsive design */
    .analytics-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
    
    @media (min-width: 640px) {
        .analytics-container {
            padding: 3rem 1.5rem;
        }
    }
    
    @media (min-width: 1024px) {
        .analytics-container {
            padding: 4rem 2rem;
        }
    }
    
    /* Chart containers - responsive */
    .chart-container {
        position: relative;
        width: 100%;
        height: 300px;
        margin-bottom: 1.5rem;
    }
    
    @media (min-width: 768px) {
        .chart-container {
            height: 350px;
        }
    }
    
    @media (min-width: 1024px) {
        .chart-container {
            height: 400px;
        }
    }
    
    /* Statistics cards - responsive grid */
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    @media (min-width: 640px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (min-width: 1024px) {
        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
    
    /* Chart grid - responsive */
    .charts-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    @media (min-width: 1024px) {
        .charts-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    /* Filter form - responsive */
    .filter-form {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }
    
    @media (min-width: 640px) {
        .filter-form {
            flex-direction: row;
            align-items: flex-end;
            gap: 1.5rem;
        }
    }
    
    .filter-form > div {
        flex: 1;
        min-width: 0;
    }
    
    /* Card styling */
    .stat-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }
    
    .chart-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
    }
    
    /* Peak day highlight */
    .peak-day-card {
        background: linear-gradient(to right, #9333ea, #ec4899);
        border-radius: 0.5rem;
        padding: 1.5rem;
        color: white;
        margin-bottom: 1.5rem;
    }
    
    /* Input styling */
    .form-input {
        width: 100%;
        padding: 0.625rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #075944;
        box-shadow: 0 0 0 3px rgba(7, 89, 68, 0.1);
    }
    
    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: #374151;
    }
    
    /* Button styling */
    .btn-primary {
        padding: 0.625rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }
    
    .btn-primary {
        background: #2563eb;
        color: white;
    }
    
    .btn-primary:hover {
        background: #1d4ed8;
    }
    
    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6b7280;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h1 class="text-3xl font-bold mb-6">Attendance Analytics</h1>
    
    <!-- Date Range Filter -->
    <div class="bg-white rounded-lg shadow-sm p-4 border mb-6">
        <form method="get" class="filter-form">
            <div>
                <label for="date_from" class="form-label">From Date</label>
                <input type="date" name="date_from" id="date_from" value="{{ date_from }}" class="form-input">
            </div>
            <div>
                <label for="date_to" class="form-label">To Date</label>
                <input type="date" name="date_to" id="date_to" value="{{ date_to }}" class="form-input">
            </div>
            <div>
                <button type="submit" class="btn-primary">Update Range</button>
            </div>
        </form>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <p class="text-sm text-gray-600">Total YouTube Views</p>
            <p class="text-2xl font-bold mt-1" style="color: #FF0000;">{{ total_youtube|floatformat:0 }}</p>
            <p class="text-xs mt-1 text-gray-500">Avg: {{ avg_youtube|floatformat:0 }}/day</p>
        </div>
        <div class="stat-card">
            <p class="text-sm text-gray-600">Total Facebook Views</p>
            <p class="text-2xl font-bold mt-1" style="color: #1877F2;">{{ total_facebook|floatformat:0 }}</p>
            <p class="text-xs mt-1 text-gray-500">Avg: {{ avg_facebook|floatformat:0 }}/day</p>
        </div>
        <div class="stat-card">
            <p class="text-sm text-gray-600">Total Views</p>
            <p class="text-2xl font-bold mt-1" style="color: #667eea;">{{ total_all|floatformat:0 }}</p>
            <p class="text-xs mt-1 text-gray-500">Avg: {{ avg_total|floatformat:0 }}/day</p>
        </div>
        <div class="stat-card">
            <p class="text-sm text-gray-600">Days Recorded</p>
            <p class="text-2xl font-bold mt-1">{{ num_days }}</p>
            <p class="text-xs mt-1 text-gray-500">Period: {{ date_from }} to {{ date_to }}</p>
        </div>
    </div>

    {% if peak_day %}
    <!-- Peak Day Highlight -->
    <div class="peak-day-card">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
                <p class="text-sm opacity-90 mb-1">üèÜ Peak Day</p>
                <p class="text-xl font-bold">{{ peak_day.date|date:"F d, Y" }}</p>
                <p class="text-sm mt-1 opacity-90">{{ peak_views|floatformat:0 }} total views</p>
            </div>
            <div class="text-left sm:text-right">
                <p class="text-sm opacity-90">YouTube: {{ peak_day.youtube_views|floatformat:0 }}</p>
                <p class="text-sm opacity-90">Facebook: {{ peak_day.facebook_views|floatformat:0 }}</p>
            </div>
        </div>
    </div>
    {% endif %}

    {% if records %}
    <!-- Charts -->
    <div class="charts-grid" id="charts-section">
        <!-- Daily Views Chart -->
        <div class="chart-card">
            <h2 class="text-lg font-semibold mb-4">Daily Views Trend</h2>
            <div class="chart-container">
                <canvas id="dailyViewsChart"></canvas>
            </div>
        </div>

        <!-- Platform Comparison Chart -->
        <div class="chart-card">
            <h2 class="text-lg font-semibold mb-4">Platform Comparison</h2>
            <div class="chart-container">
                <canvas id="platformChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Weekly Aggregates Chart -->
    <div class="chart-card">
        <h2 class="text-lg font-semibold mb-4">Weekly Views Summary</h2>
        <div class="chart-container">
            <canvas id="weeklyChart"></canvas>
        </div>
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <p class="text-lg text-gray-600">No attendance records found for the selected date range.</p>
    </div>
    {% endif %}
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Wait for DOM and Chart.js to be ready
document.addEventListener('DOMContentLoaded', function() {
    // Check if Chart is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js library failed to load');
        return;
    }

    // Check if we have data
    const hasData = {{ records|length }} > 0;
    if (!hasData) {
        console.log('No attendance records to display');
        return;
    }

    // Parse JSON data safely
    let dates, youtube_views, facebook_views, total_views, weekly_dates, weekly_youtube, weekly_facebook, weekly_total;
    try {
        dates = {{ dates|safe }};
        youtube_views = {{ youtube_views|safe }};
        facebook_views = {{ facebook_views|safe }};
        total_views = {{ total_views|safe }};
        weekly_dates = {{ weekly_dates|safe }};
        weekly_youtube = {{ weekly_youtube|safe }};
        weekly_facebook = {{ weekly_facebook|safe }};
        weekly_total = {{ weekly_total|safe }};
    } catch (e) {
        console.error('Error parsing chart data:', e);
        return;
    }

    // Daily Views Line Chart
    const dailyCtx = document.getElementById('dailyViewsChart');
    if (!dailyCtx) {
        console.error('dailyViewsChart canvas not found');
        return;
    }
    
    new Chart(dailyCtx.getContext('2d'), {
        type: 'line',
        data: {
            labels: dates || [],
            datasets: [
                {
                    label: 'YouTube Views',
                    data: youtube_views || [],
                    borderColor: '#FF0000',
                    backgroundColor: 'rgba(255, 0, 0, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                },
                {
                    label: 'Facebook Views',
                    data: facebook_views || [],
                    borderColor: '#1877F2',
                    backgroundColor: 'rgba(24, 119, 242, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                },
                {
                    label: 'Total Views',
                    data: total_views || [],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Platform Comparison Bar Chart
    const platformCtx = document.getElementById('platformChart');
    if (!platformCtx) {
        console.error('platformChart canvas not found');
        return;
    }
    
    new Chart(platformCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['YouTube', 'Facebook', 'Total'],
            datasets: [{
                label: 'Total Views',
                data: [
                    {{ total_youtube|default:0 }},
                    {{ total_facebook|default:0 }},
                    {{ total_all|default:0 }}
                ],
                backgroundColor: [
                    '#FF0000',
                    '#1877F2',
                    '#667eea'
                ],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Weekly Aggregates Chart
    const weeklyCtx = document.getElementById('weeklyChart');
    if (!weeklyCtx) {
        console.error('weeklyChart canvas not found');
        return;
    }
    
    new Chart(weeklyCtx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: weekly_dates || [],
            datasets: [
                {
                    label: 'YouTube',
                    data: weekly_youtube || [],
                    backgroundColor: '#FF0000',
                    borderRadius: 4
                },
                {
                    label: 'Facebook',
                    data: weekly_facebook || [],
                    backgroundColor: '#1877F2',
                    borderRadius: 4
                },
                {
                    label: 'Total',
                    data: weekly_total || [],
                    backgroundColor: '#667eea',
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}); // End DOMContentLoaded
</script>
{% endblock %}
