{% extends 'base.html' %}
{% load static %}

{% block title %}Book a Counseling Session - Uplift Your Morning{% endblock %}

{% block meta_description %}Book a one-on-one counseling session with our team. Submit your request and we'll confirm your appointment time.{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/css/intlTelInput.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    #phone-wrapper { position: relative; width: 100%; }
    .iti { width: 100%; display: block; }
    .iti__flag-container { z-index: 10; }
    .iti input { width: 100% !important; padding-left: 52px !important; }
    .iti__selected-flag { padding: 0 8px 0 12px; }
    .iti__country-list { z-index: 9999; }
    .flatpickr-calendar {
        font-family: inherit;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .flatpickr-day.selected {
        background: var(--primary) !important;
        border-color: var(--primary) !important;
    }
    .flatpickr-day.today {
        border-color: var(--primary) !important;
    }
    input[type="date"]:invalid::-webkit-datetime-edit {
        color: #999;
    }
    /* Date input with icon */
    .date-picker-wrapper {
        position: relative;
    }
    .date-picker-wrapper input {
        padding-right: 2.75rem !important; /* Make room for icon */
    }
    .date-picker-wrapper svg {
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<section class="py-12 sm:py-16 md:py-20" style="background: #FFFFFF;">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8 sm:mb-12">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold mb-4" style="color: var(--text);">Book a Counseling Session</h1>
            <p class="text-lg sm:text-xl leading-relaxed font-medium" style="color: var(--text_secondary);">
                We're here to support you on your spiritual journey. Fill out the form below to request a counseling session, and we'll confirm your appointment time.
            </p>
        </div>

        <!-- Important Information Box -->
        <div class="mb-6 sm:mb-8 bg-amber-50 border border-amber-200 rounded-lg p-4 sm:p-6">
            <div class="flex items-start">
                <svg class="w-5 h-5 mt-0.5 mr-3 flex-shrink-0" style="color: #f59e0b;" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <div>
                    <h3 class="font-semibold mb-2" style="color: #92400e;">Important Information</h3>
                    <ul class="space-y-2 text-sm" style="color: #78350f;">
                        <li class="flex items-start">
                            <span class="mr-2 font-semibold">•</span>
                            <span><strong>Maximum Sessions:</strong> Each person can book a maximum of 30 counseling sessions.</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2 font-semibold">•</span>
                            <span><strong>Team Assignment:</strong> You will be assigned to a member of our counseling team based on availability and your specific needs.</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Booking Form -->
        <div class="bg-white rounded-2xl shadow-lg border p-6 sm:p-8 md:p-10" style="border-color: var(--border);">
            <form method="post" class="space-y-6">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <ul class="list-disc list-inside text-sm text-red-800">
                        {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- Contact Information Section -->
                <div>
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6" style="color: var(--text);">Contact Information</h2>
                    <div class="grid sm:grid-cols-2 gap-4 sm:gap-6">
                        <div class="sm:col-span-2">
                            <label for="{{ form.full_name.id_for_label }}" class="block text-sm font-semibold mb-2" style="color: var(--text);">Full Name *</label>
                            {{ form.full_name }}
                            {% if form.full_name.errors %}
                            <p class="text-sm text-red-600 mt-1">{{ form.full_name.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="{{ form.email.id_for_label }}" class="block text-sm font-semibold mb-2" style="color: var(--text);">Email Address (Optional)</label>
                            {{ form.email }}
                            {% if form.email.errors %}
                            <p class="text-sm text-red-600 mt-1">{{ form.email.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="{{ form.phone.id_for_label }}" class="block text-sm font-semibold mb-2" style="color: var(--text);">Phone Number *</label>
                            <div id="phone-wrapper">
                                {{ form.phone }}
                            </div>
                            {% if form.phone.errors %}
                            <p class="text-sm text-red-600 mt-1">{{ form.phone.errors.0 }}</p>
                            {% endif %}
                            <p class="text-xs mt-1" style="color: var(--text_light);">
                                Select your country and enter your phone number.
                            </p>
                        </div>
                        
                        <div class="sm:col-span-2">
                            <label for="{{ form.country.id_for_label }}" class="block text-sm font-semibold mb-2" style="color: var(--text);">Country (Optional)</label>
                            {{ form.country }}
                            {% if form.country.errors %}
                            <p class="text-sm text-red-600 mt-1">{{ form.country.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Booking Details Section -->
                <div class="border-t pt-6" style="border-color: var(--border);">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6" style="color: var(--text);">Session Details</h2>
                    <div class="grid sm:grid-cols-2 gap-4 sm:gap-6">
                        <div>
                            <label for="{{ form.preferred_date.id_for_label }}" class="block text-sm font-semibold mb-2" style="color: var(--text);">Preferred Date *</label>
                            <div class="relative date-picker-wrapper">
                                {{ form.preferred_date }}
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <svg class="w-5 h-5" style="color: var(--text_secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                            </div>
                            {% if form.preferred_date.errors %}
                            <p class="text-sm text-red-600 mt-1">{{ form.preferred_date.errors.0 }}</p>
                            {% endif %}
                            <p class="text-xs mt-1" style="color: var(--text_light);">Select your preferred date for the session</p>
                        </div>
                        
                        <div>
                            <label for="{{ form.preferred_time.id_for_label }}" class="block text-sm font-semibold mb-2" style="color: var(--text);">Preferred Time *</label>
                            {{ form.preferred_time }}
                            {% if form.preferred_time.errors %}
                            <p class="text-sm text-red-600 mt-1">{{ form.preferred_time.errors.0 }}</p>
                            {% endif %}
                            <p class="text-xs mt-1" style="color: var(--text_light);">Select your preferred time</p>
                        </div>
                        
                        <div class="sm:col-span-2">
                            <label for="{{ form.duration_minutes.id_for_label }}" class="block text-sm font-semibold mb-2" style="color: var(--text);">Session Duration *</label>
                            {{ form.duration_minutes }}
                            {% if form.duration_minutes.errors %}
                            <p class="text-sm text-red-600 mt-1">{{ form.duration_minutes.errors.0 }}</p>
                            {% endif %}
                            <p class="text-xs mt-1" style="color: var(--text_light);">All counseling sessions are 30 minutes in duration.</p>
                        </div>
                    </div>
                </div>

                <!-- Additional Information Section -->
                <div class="border-t pt-6" style="border-color: var(--border);">
                    <h2 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6" style="color: var(--text);">Additional Information</h2>
                    <div class="space-y-4 sm:space-y-6">
                        <div>
                            <label for="{{ form.topic.id_for_label }}" class="block text-sm font-semibold mb-2" style="color: var(--text);">Topic or Reason (Optional)</label>
                            {{ form.topic }}
                            {% if form.topic.errors %}
                            <p class="text-sm text-red-600 mt-1">{{ form.topic.errors.0 }}</p>
                            {% endif %}
                            <p class="text-xs mt-1" style="color: var(--text_light);">Briefly describe what you'd like to discuss</p>
                        </div>
                        
                        <div>
                            <label for="{{ form.message.id_for_label }}" class="block text-sm font-semibold mb-2" style="color: var(--text);">Additional Message (Optional)</label>
                            {{ form.message }}
                            {% if form.message.errors %}
                            <p class="text-sm text-red-600 mt-1">{{ form.message.errors.0 }}</p>
                            {% endif %}
                            <p class="text-xs mt-1" style="color: var(--text_light);">Any additional details you'd like to share</p>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="border-t pt-6" style="border-color: var(--border);">
                    <button type="submit" 
                            class="w-full px-6 py-3.5 rounded-lg font-semibold text-white transition-all shadow-sm hover:shadow-md"
                            style="background: var(--primary); font-size: 16px;"
                            onmouseover="this.style.background='var(--primary_hover)'"
                            onmouseout="this.style.background='var(--primary)'">
                        Submit Booking Request
                    </button>
                    <p class="text-xs text-center mt-3" style="color: var(--text_light);">
                        Your request will be reviewed and you'll receive an email and SMS confirmation once approved.
                    </p>
                </div>
            </form>
        </div>

        <!-- Information Box -->
        <div class="mt-8 sm:mt-10 bg-blue-50 border border-blue-200 rounded-lg p-4 sm:p-6">
            <h3 class="font-semibold mb-2" style="color: var(--text);">What happens next?</h3>
            <ul class="space-y-2 text-sm" style="color: var(--text_secondary);">
                <li class="flex items-start">
                    <span class="mr-2">1.</span>
                    <span>Submit your booking request with your preferred date and time.</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">2.</span>
                    <span>Our team will review your request and check availability.</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">3.</span>
                    <span>Once approved, you'll receive an email and SMS with the confirmed appointment details.</span>
                </li>
                <li class="flex items-start">
                    <span class="mr-2">4.</span>
                    <span>The session will be added to our calendar and you'll receive a calendar invite.</span>
                </li>
            </ul>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/js/intlTelInput.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Date picker
        const dateInput = document.getElementById('{{ form.preferred_date.id_for_label }}');
        if (dateInput) {
            flatpickr(dateInput, {
                minDate: 'today',
                dateFormat: 'Y-m-d',
                disableMobile: true,
            });
        }
        // International phone input
        const phoneInput = document.getElementById('{{ form.phone.id_for_label }}');
        if (phoneInput && typeof window.intlTelInput !== 'undefined' && !phoneInput.closest('.iti')) {
            phoneInput.type = 'tel';
            phoneInput.setAttribute('autocomplete', 'tel');
            var iti = window.intlTelInput(phoneInput, {
                initialCountry: "gh",
                preferredCountries: ['gh', 'ng', 'us', 'gb', 'za', 'ke', 'tz'],
                separateDialCode: true,
                nationalMode: false,
                autoPlaceholder: "polite",
                utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.6/build/js/utils.js",
                geoIpLookup: function(cb) {
                    fetch("https://ipapi.co/json/").then(function(r) { return r.json(); })
                        .then(function(d) { cb(d && d.country_code ? d.country_code.toLowerCase() : "gh"); })
                        .catch(function() { cb("gh"); });
                },
            });
            phoneInput.addEventListener('blur', function() {
                if (phoneInput.value && iti.isValidNumber()) phoneInput.value = iti.getNumber();
            });
            phoneInput.closest('form').addEventListener('submit', function() {
                if (phoneInput.value && iti) {
                    try { if (iti.isValidNumber()) phoneInput.value = iti.getNumber(); else { var n = iti.getNumber(); if (n) phoneInput.value = n; } } catch(e) {}
                }
            });
        }
    });
</script>
{% endblock %}

